<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <UsingTask AssemblyFile="$(MSBuildThisFileDirectory)bin/Debug/net6.0/KeepAChangelog.Tasks.dll" TaskName="KeepAChangelog.Tasks.ParseChangeLogs"/>

    <PropertyGroup>
        <PrepareForBuildDependsOn>
            SetVersionFromChangelog;
            $(PrepareForBuildDependsOn)
          </PrepareForBuildDependsOn>
    </PropertyGroup>
    
    <Target Name="GetChangelogVersion"
        Condition="'$(ChangelogFile)' != '' and Exists('$(ChangelogFile)')"
        Inputs="$(ChangelogFile)"
        Outputs="UnreleasedChangelog;CurrentReleaseChangelog;AllReleasedChangelogslLatestReleaseNotes">
        <KeepAChangelog.Tasks.ParseChangeLogs 
            ChangelogFile="$(ChangelogFile)">
            <Output TaskParameter="UnreleasedChangelog" ItemName="UnreleasedChangelog"/>
            <Output TaskParameter="CurrentReleaseChangelog" ItemName="CurrentReleaseChangelog"/>
            <Output TaskParameter="AllReleasedChangelogs" ItemName="AllReleasedChangelogs" />
            <Output TaskParameter="LatestReleaseNotes" ItemName="LatestReleaseNotes" />
        </KeepAChangelog.Tasks.ParseChangeLogs>
    </Target>

    <Target Name="SetVersionFromChangelog"
            DependsOnTargets="GetChangelogVersion">
        <PropertyGroup Condition="'@(CurrentReleaseChangelog)' != ''">
            <Version>%(CurrentReleaseChangelog.Identity)</Version>
            <PackageVersion>%(CurrentReleaseChangelog.Identity)</PackageVersion>
            <PackageReleaseNotes>@(LatestReleaseNotes)</PackageReleaseNotes>
        </PropertyGroup>
    </Target>

</Project>